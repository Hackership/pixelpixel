<polymer-element name="pixel-codeinspector" attributes="key">
	<template>
		<link href="css/codeinspector.css" rel="stylesheet" type="text/css" />
		<polymer-ui-tabs id="files" valueattr="innerText">
			<span>hai</span>
		</polymer-ui-tabs>
		<pixel-code id="code"></pixel-code>

		<div class="icon" id="close">
			<div class="cross"></div>
		</div>
		<div class="icon" id="reload">
			<div class="reload"></div>
		</div>
	</template>
	<script>
		function removeAllChildren(node) {
			while (node.hasChildNodes()) {
			    node.removeChild(node.lastChild);
			}
		}

		function newTabNode(title) {
			var node = document.createElement('span');
			node.innerText = title;
			return node;
		}

		Polymer('pixel-codeinspector', {
			key: '',
			files: {},
			empty: function() {
				this.files = {};
				removeAllChildren(this.$.files);
				this.$.code.innerText = '';
			},
			updateTabs: function() {
				this.$.files.appendChild(newTabNode('Logs'));
				_(this.files).each(function(_, filename) {
					console.log(filename);
					if(filename == 'Logs') {
						return;
					}
					this.$.files.appendChild(newTabNode(filename));
				}.bind(this));
				console.log(this.$.files);
				this.$.files.selected = 'Logs';
			},
			updateContent: function() {
				var file = this.$.files.selected;
				var content = '';
				if(file in this.files) {
					content = this.files[file];
				}
				this.$.code.innerText = content;
				if(/\.go$/.test(file)) {
					this.$.code.language = 'go';
				} else {
					this.$.code.language = 'plain';
				}
				this.$.code.update();
			},
			reloadFiles: function() {
				var xhr = new XMLHttpRequest();
				reqwest({
					method: 'GET',
					url: '/pixels/'+this.key+'/fs',
					type: 'json'
				}).then(function(data) {
					this.files = data;
					return reqwest({
						method: 'GET',
						url: '/pixels/'+this.key+'/logs',
						type: 'html' // i.e. don't try to parse
					});
				}.bind(this)).then(function(data) {
					this.files['Logs'] = data.request.responseText;
					this.updateTabs();
					this.updateContent();
				}.bind(this));
			},
			reload: function() {
				this.empty();
				this.reloadFiles();
			},
			keyChanged: function() {
				this.reload();
			},
			ready: function() {
				var oldFn = this.$.files.selectedChanged.bind(this.$.files);
				this.$.files.selectedChanged = function() {
					oldFn();
					this.updateContent();
				}.bind(this);
				this.$.close.addEventListener('click', function() {
					this.fire('close');
				}.bind(this))
				this.$.reload.addEventListener('click', function() {
					this.reload();
				}.bind(this))
			},
		});
	</script>
</polymer-element>
